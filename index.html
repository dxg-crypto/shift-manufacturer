<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shift Maker Pro Ver 26.7</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <!-- Babel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <style>
        body { font-family: sans-serif; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fadeIn { animation: fadeIn 0.3s ease-out forwards; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        
        .sticky-name-col {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: white !important;
            border-right: 2px solid #e2e8f0;
            white-space: nowrap !important;
            min-width: 160px;
            padding-left: 0.75rem !important;
            padding-right: 0.75rem !important;
        }
        th.sticky-name-col {
            background-color: #f1f5f9 !important;
            z-index: 30;
        }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- アイコン (SVG内蔵) ---
        const Icon = ({ name, size = 16, className = "" }) => {
            const paths = {
                Calendar: <g><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></g>,
                Users: <g><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></g>,
                Settings: <g><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></g>,
                CheckCircle: <g><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></g>,
                Trash2: <g><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></g>,
                RefreshCw: <g><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></g>,
                User: <g><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></g>,
                Star: <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>,
                Truck: <g><rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></g>,
                Flag: <g><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" y1="22" x2="4" y2="15"/></g>,
                LogIn: <g><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></g>,
                FileSpreadsheet: <g><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="16" y2="17"/></g>,
                Briefcase: <g><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></g>,
                ChevronUp: <polyline points="18 15 12 9 6 15" />,
                ChevronDown: <polyline points="6 9 12 15 18 9" />,
                Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
                Baby: <g><path d="M9 12h.01"/><path d="M15 12h.01"/><path d="M10 16c.5.3 1.2.5 2 .5s1.5-.2 2-.5"/><path d="M19 6.3a9 9 0 0 1 1.8 3.9 2 2 0 0 1 0 3.6 9 9 0 0 1-17.6 0 2 2 0 0 1 0-3.6A9 9 0 0 1 12 3c2 0 3.5 1.1 3.5 2.5s-.9 2.5-2 2.5c-.8 0-1.5-.4-1.5-1"/></g>
            };
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {paths[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        // --- 定数・初期設定 ---

        const ROLES = {
          MANAGER: { id: 'manager', label: '店長', color: 'bg-purple-100 text-purple-800', hexBg: '#f3e8ff', hexText: '#6b21a8', icon: <Icon name="Star" size={14} /> },
          VICE_MANAGER: { id: 'vice_manager', label: '副店長', color: 'bg-purple-50 text-purple-700', hexBg: '#faf5ff', hexText: '#7e22ce', icon: <Icon name="Star" size={12} /> },
          CREW: { id: 'crew', label: 'クルー', color: 'bg-blue-100 text-blue-800', hexBg: '#dbeafe', hexText: '#1e40af', icon: <Icon name="User" size={14} /> },
          ROOKIE: { id: 'rookie', label: '新人', color: 'bg-yellow-100 text-yellow-800', hexBg: '#fef9c3', hexText: '#854d0e', icon: <Icon name="Baby" size={14} /> },
          PART_TIME: { id: 'part_time', label: 'バイト', color: 'bg-green-100 text-green-800', hexBg: '#dcfce7', hexText: '#166534', icon: <Icon name="User" size={14} /> },
          DISPATCH: { id: 'dispatch', label: '派遣', color: 'bg-orange-100 text-orange-800', hexBg: '#ffedd5', hexText: '#9a3412', icon: <Icon name="Briefcase" size={14} /> },
          HELP_GUEST: { id: 'help_guest', label: 'ヘルプ(受入)', color: 'bg-teal-100 text-teal-800', hexBg: '#ccfbf1', hexText: '#115e59', icon: <Icon name="LogIn" size={14} /> },
          EVENT: { id: 'event', label: 'イベント専属', color: 'bg-red-100 text-red-800', hexBg: '#fee2e2', hexText: '#991b1b', icon: <Icon name="Star" size={14} /> },
        };

        const WEEKDAYS = ['日', '月', '火', '水', '木', '金', '土'];

        const HOLIDAYS_2025 = [
          '2025-01-01', '2025-01-13', '2025-02-11', '2025-02-23', '2025-02-24',
          '2025-03-20', '2025-04-29', '2025-05-03', '2025-05-04', '2025-05-05',
          '2025-05-06', '2025-07-21', '2025-08-11', '2025-09-15', '2025-09-23',
          '2025-10-13', '2025-11-03', '2025-11-23', '2025-11-24'
        ];

        const DEFAULT_STORE_EVENT_TYPES = [
          { id: 'sevt_default', name: 'イベント', color: 'bg-red-500 text-white', hexBg:'#ef4444', hexText:'#ffffff', requiredAdd: 0 } 
        ];

        const DEFAULT_STAFF_EVENT_TYPES = [
          { id: 'se_1', name: '会議', color: 'bg-indigo-200 text-indigo-800', hexBg: '#c7d2fe', hexText: '#3730a3' },
          { id: 'se_2', name: '巡回', color: 'bg-emerald-200 text-emerald-800', hexBg: '#a7f3d0', hexText: '#065f46' },
        ];

        const FIXED_OFF_DAYS = 10; 
        const MAX_CONSECUTIVE_WORK = 5; 

        // --- 独立したコンポーネント ---
        const TabButton = ({ id, label, icon, isActive, onClick }) => (
          <button
            onClick={() => onClick(id)}
            className={`flex items-center gap-2 px-3 py-3 border-b-2 text-sm whitespace-nowrap transition-colors ${
              isActive ? 'border-blue-600 text-blue-600 bg-blue-50 font-bold' : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            <Icon name={icon} size={16} />{label}
          </button>
        );

        function App() {
          const [activeTab, setActiveTab] = useState('settings'); 
          
          // 1. 基本設定 
          const [storeName, setStoreName] = useState('');
          const [year, setYear] = useState(2025);
          const [month, setMonth] = useState(5);
          const [reqWeekday, setReqWeekday] = useState(2);
          const [reqWeekend, setReqWeekend] = useState(3);
          const [reqEvent, setReqEvent] = useState(4);
          const [shiftMode, setShiftMode] = useState('complex');
          const [closedWeekDays, setClosedWeekDays] = useState([]); 
          const [specificClosedDays, setSpecificClosedDays] = useState([]); 

          // 2. スタッフデータ
          const [staffList, setStaffList] = useState([
            { id: 1, name: '佐藤一郎', role: 'manager', isTrainer: true, wantConsecutive: false },
            { id: 2, name: '鈴木花子', role: 'vice_manager', isTrainer: true, wantConsecutive: false },
            { id: 3, name: '田中次郎', role: 'crew', isTrainer: false, wantConsecutive: false },
            { id: 4, name: '高橋美咲', role: 'part_time', isTrainer: false, wantConsecutive: true },
            { id: 5, name: '新人太郎', role: 'rookie', isTrainer: false, wantConsecutive: false },
            { id: 6, name: 'イベント担当', role: 'event', isTrainer: false, wantConsecutive: false },
            { id: 99, name: '新宿店よりヘルプ', role: 'help_guest', isTrainer: false, wantConsecutive: false },
          ]);
          const [newStaffName, setNewStaffName] = useState('');
          const [newStaffRole, setNewStaffRole] = useState('crew');

          // 3. ヘルプ設定
          const [helpStores, setHelpStores] = useState([]); 
          const [newHelpStore, setNewHelpStore] = useState('');

          // 4. イベント・行事マスタ
          const [storeEventTypes, setStoreEventTypes] = useState(DEFAULT_STORE_EVENT_TYPES);
          const [newStoreEventName, setNewStoreEventName] = useState('');
          const [staffEventTypes, setStaffEventTypes] = useState(DEFAULT_STAFF_EVENT_TYPES);
          const [newStaffEventName, setNewStaffEventName] = useState('');

          // 5. 日別・個別設定
          const [dailyStoreEvents, setDailyStoreEvents] = useState({});
          const [requests, setRequests] = useState({});
          const [helpAssignments, setHelpAssignments] = useState({});

          // 6. 生成結果
          const [schedule, setSchedule] = useState(null);
          const [generationLog, setGenerationLog] = useState([]);

          // --- Persistence ---
          const STORAGE_KEY = 'shift_maker_pro_data_v26_7';

          // ブラウザ保存
          const saveToLocal = () => {
            const data = getExportData();
            data.schedule = schedule;
            data.generationLog = generationLog;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
            alert("ブラウザに現在の状態を保存しました。");
          };

          // 初期化
          const resetLocal = () => {
            if (confirm("すべてのデータを削除して初期化しますか？")) {
                localStorage.removeItem(STORAGE_KEY);
                window.location.reload();
            }
          };

          const getExportData = () => ({
            storeName, year, month,
            reqWeekday, reqWeekend, reqEvent, shiftMode,
            closedWeekDays, specificClosedDays,
            staffList, helpStores,
            storeEventTypes, staffEventTypes,
            dailyStoreEvents, requests, helpAssignments 
          });

          const loadData = (parsed) => {
            if (parsed.storeName !== undefined) setStoreName(parsed.storeName);
            if (parsed.year !== undefined) setYear(parsed.year);
            if (parsed.month !== undefined) setMonth(parsed.month);
            if (parsed.reqWeekday !== undefined) setReqWeekday(parsed.reqWeekday);
            if (parsed.reqWeekend !== undefined) setReqWeekend(parsed.reqWeekend);
            if (parsed.reqEvent !== undefined) setReqEvent(parsed.reqEvent);
            if (parsed.shiftMode !== undefined) setShiftMode(parsed.shiftMode);
            if (parsed.closedWeekDays) setClosedWeekDays(parsed.closedWeekDays);
            if (parsed.specificClosedDays) setSpecificClosedDays(parsed.specificClosedDays);
            if (parsed.staffList) setStaffList(parsed.staffList);
            if (parsed.helpStores) setHelpStores(parsed.helpStores);
            if (parsed.storeEventTypes) setStoreEventTypes(parsed.storeEventTypes);
            if (parsed.staffEventTypes) setStaffEventTypes(parsed.staffEventTypes);
            if (parsed.dailyStoreEvents) setDailyStoreEvents(parsed.dailyStoreEvents);
            if (parsed.requests) setRequests(parsed.requests);
            if (parsed.helpAssignments) setHelpAssignments(parsed.helpAssignments);
            if (parsed.schedule) setSchedule(parsed.schedule);
            if (parsed.generationLog) setGenerationLog(parsed.generationLog);
          };

          useEffect(() => {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
              try {
                loadData(JSON.parse(saved));
              } catch (e) { console.error("Load Error", e); }
            } else {
              setYear(new Date().getFullYear());
            }
          }, []);

          // --- Helpers ---
          const getDaysInMonth = (y, m) => new Date(y, m, 0).getDate();
          const daysInMonth = getDaysInMonth(year, month);
          const dateList = Array.from({ length: daysInMonth }, (_, i) => i + 1);
          const getDateKey = (d) => `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          
          const getWeekDayIndex = (d) => new Date(year, month - 1, d).getDay();
          const getWeekDay = (d) => WEEKDAYS[getWeekDayIndex(d)];
          const isWeekend = (d) => { const w = getWeekDayIndex(d); return w === 0 || w === 6; };
          const isHoliday = (d) => HOLIDAYS_2025.includes(getDateKey(d));
          
          const isClosed = (d) => {
            const dateKey = getDateKey(d);
            if (specificClosedDays.includes(dateKey)) return true;
            return closedWeekDays.includes(getWeekDayIndex(d));
          };

          const isEventDay = (d) => {
            const key = getDateKey(d);
            const evtId = dailyStoreEvents[key];
            if (!evtId) return false;
            const evtDef = storeEventTypes.find(e => e.id === evtId);
            return !!evtDef; 
          };

          const getRequiredNum = (d) => {
            if (isEventDay(d)) return reqEvent;
            if (isWeekend(d) || isHoliday(d)) return reqWeekend;
            return reqWeekday;
          };
          
          // --- Handlers ---
          const addStaff = () => {
            if (!newStaffName) return;
            const newId = staffList.length > 0 ? Math.max(...staffList.map(s => s.id)) + 1 : 1;
            setStaffList([...staffList, { id: newId, name: newStaffName, role: newStaffRole, isTrainer: false, wantConsecutive: false }]);
            setNewStaffName('');
          };
          const removeStaff = (id) => setStaffList(staffList.filter(s => s.id !== id));
          
          // 並べ替え機能
          const moveStaff = (index, direction) => {
            const newList = [...staffList];
            const targetIndex = index + direction;
            if (targetIndex < 0 || targetIndex >= newList.length) return;
            [newList[index], newList[targetIndex]] = [newList[targetIndex], newList[index]];
            setStaffList(newList);
          };

          // 属性トグル
          const toggleStaffAttribute = (id, attr) => {
            setStaffList(staffList.map(s => s.id === id ? { ...s, [attr]: !s[attr] } : s));
          };

          const addHelpStore = () => {
            if (newHelpStore && !helpStores.includes(newHelpStore)) setHelpStores([...helpStores, newHelpStore]);
            setNewHelpStore('');
          };
          const removeHelpStore = (n) => setHelpStores(helpStores.filter(s => s !== n));

          const toggleClosedWeekDay = (dayIndex) => {
            if (closedWeekDays.includes(dayIndex)) setClosedWeekDays(closedWeekDays.filter(d => d !== dayIndex));
            else setClosedWeekDays([...closedWeekDays, dayIndex]);
          };
          const toggleSpecificClosedDay = (d) => {
            const key = getDateKey(d);
            if (specificClosedDays.includes(key)) setSpecificClosedDays(specificClosedDays.filter(k => k !== key));
            else setSpecificClosedDays([...specificClosedDays, key]);
          };

          const addStoreEventType = () => {
            if (!newStoreEventName) return;
            setStoreEventTypes([...storeEventTypes, { id: `sevt_${Date.now()}`, name: newStoreEventName, color: 'bg-gray-700 text-white', hexBg:'#374151', hexText:'#fff', requiredAdd: 0 }]);
            setNewStoreEventName('');
          };
          const removeStoreEventType = (id) => setStoreEventTypes(storeEventTypes.filter(e => e.id !== id));

          const addStaffEventType = () => {
            if (!newStaffEventName) return;
            setStaffEventTypes([...staffEventTypes, { id: `stevt_${Date.now()}`, name: newStaffEventName, color: 'bg-cyan-200 text-cyan-800', hexBg:'#a5f3fc', hexText:'#155e75' }]);
            setNewStaffEventName('');
          };
          const removeStaffEventType = (id) => setStaffEventTypes(staffEventTypes.filter(e => e.id !== id));

          const toggleDailyStoreEvent = (d) => {
            const key = getDateKey(d);
            const currentId = dailyStoreEvents[key];
            if (!currentId) {
              if (storeEventTypes.length > 0) setDailyStoreEvents({ ...dailyStoreEvents, [key]: storeEventTypes[0].id });
            } else {
              const idx = storeEventTypes.findIndex(e => e.id === currentId);
              if (idx >= 0 && idx < storeEventTypes.length - 1) {
                setDailyStoreEvents({ ...dailyStoreEvents, [key]: storeEventTypes[idx + 1].id });
              } else {
                const newEvs = { ...dailyStoreEvents };
                delete newEvs[key];
                setDailyStoreEvents(newEvs);
              }
            }
          };

          const handleRequestChange = (staffId, d, role) => {
            const key = `${staffId}_${getDateKey(d)}`;
            const current = requests[key];
            
            if (role === 'help_guest' || role === 'event') {
              const mark = role === 'event' ? 'event_in' : 'guest_in';
              if (current === mark) {
                const n = { ...requests }; delete n[key]; setRequests(n);
              } else {
                setRequests({ ...requests, [key]: mark });
              }
              return;
            }

            if (!current) setRequests({ ...requests, [key]: 'off' });
            else if (current === 'off') setRequests({ ...requests, [key]: 'paid' });
            else if (current === 'paid') {
              if (staffEventTypes.length > 0) setRequests({ ...requests, [key]: staffEventTypes[0].id });
              else { const n = { ...requests }; delete n[key]; setRequests(n); }
            } else {
              const idx = staffEventTypes.findIndex(e => e.id === current);
              if (idx !== -1 && idx < staffEventTypes.length - 1) {
                setRequests({ ...requests, [key]: staffEventTypes[idx + 1].id });
              } else { 
                const n = { ...requests }; 
                delete n[key]; 
                setRequests(n); 
              }
            }
          };

          const toggleAllHelpDates = (staffId, role) => {
            const mark = role === 'event' ? 'event_in' : 'guest_in';
            const isAllSelected = dateList.every(d => requests[`${staffId}_${getDateKey(d)}`] === mark);
            let newRequests = { ...requests };
            dateList.forEach(d => {
              const key = `${staffId}_${getDateKey(d)}`;
              if (isAllSelected) delete newRequests[key];
              else newRequests[key] = mark;
            });
            setRequests(newRequests);
          };

          const handleHelpAssignment = (staffId, d, storeName) => {
            const key = `${staffId}_${getDateKey(d)}`;
            const newAssign = { ...helpAssignments };
            if (storeName === '') delete newAssign[key];
            else newAssign[key] = storeName;
            setHelpAssignments(newAssign);
          };

          // --- Shift Logic Core ---
          const generateShift = () => {
            let newSchedule = {};
            let logs = [];
            
            // 準備: スタッフごとの状態管理
            // シミュレーション用の配列を作る (dayIndex: 0..daysInMonth-1)
            const staffSim = staffList.map(s => ({
                id: s.id,
                role: s.role,
                isTrainer: s.isTrainer,
                wantConsecutive: s.wantConsecutive,
                name: s.name,
                isFullTime: !['help_guest', 'event'].includes(s.role),
                assigns: Array(daysInMonth).fill(null), // 0:出勤(type), null:未定, "OFF":休み
                consecutive: 0, // 現在の連勤数カウンター
                offCount: 0
            }));

            // 1. 確定情報の埋め込み (希望休・定休・行事・ヘルプ・イベント出勤)
            for (let i = 0; i < daysInMonth; i++) {
                const d = i + 1;
                const dateKey = getDateKey(d);
                const isDayClosed = isClosed(d);

                staffSim.forEach(s => {
                    const req = requests[`${s.id}_${dateKey}`];
                    const help = helpAssignments[`${s.id}_${dateKey}`];
                    
                    if (isDayClosed) {
                        s.assigns[i] = "定休";
                    } else if (help) {
                        s.assigns[i] = help; // 他店ヘルプ (出勤扱い)
                    } else if (!s.isFullTime) {
                        // スポット
                        const mark = s.role === 'event' ? 'event_in' : 'guest_in';
                        if (req === mark) {
                            // 出勤希望あり。後でシフトタイプ決めるため一時的にマーク
                            s.assigns[i] = "REQ_IN"; 
                        } else {
                            s.assigns[i] = "-"; // 休み扱い
                        }
                    } else {
                        // フルタイム
                        if (req === 'off') s.assigns[i] = "希望";
                        else if (req === 'paid') s.assigns[i] = "有給";
                        else if (req) {
                            // 行事
                            const ev = staffEventTypes.find(e => e.id === req);
                            if (ev) s.assigns[i] = ev.name; // 行事名
                        }
                    }
                });
            }

            // 2. 日次割り当てループ
            for (let i = 0; i < daysInMonth; i++) {
                const d = i + 1;
                const dateKey = getDateKey(d);
                if (isClosed(d)) {
                    staffSim.forEach(s => s.consecutive = 0);
                    continue;
                }

                const targetNum = getRequiredNum(d);
                
                // 候補者抽出
                // まだ決まっていないフルタイム or REQ_INのスポット
                let candidates = staffSim.filter(s => s.assigns[i] === null || s.assigns[i] === "REQ_IN");
                let assigned = [];

                // トレーナーと新人のペアリングマップ作成
                // 新人が候補にいる場合、対応するトレーナーを探す
                let rookieTrainerMap = new Map(); // rookie -> trainer
                let trainerUsed = new Set();

                // 新人を先に走査してトレーナー確保
                const rookies = candidates.filter(s => s.role === 'rookie');
                const trainers = candidates.filter(s => s.isTrainer);

                rookies.forEach(r => {
                    // ペアになれるトレーナーを探す
                    // 連勤上限などで「今日出勤できないトレーナー」はcandidatesにいないはずだが、
                    // ここで連勤チェックも兼ねる
                    
                    // 候補の中から、まだペアになっていないトレーナーを探す
                    let t = trainers.find(tr => !trainerUsed.has(tr.id));
                    // いなければ、既にペアになっているトレーナーでも可（多対1）
                    if (!t) t = trainers.find(tr => true); 

                    if (t) {
                        // トレーナーも出勤可能かチェック(連勤など)
                        if (t.consecutive < MAX_CONSECUTIVE_WORK) {
                            rookieTrainerMap.set(r.id, t);
                            trainerUsed.add(t.id);
                        } else {
                            // トレーナーが連勤限界で出られないなら新人も休み
                            r.assigns[i] = "公休";
                            r.consecutive = 0;
                        }
                    } else {
                        // トレーナー不在なら新人は休み
                        r.assigns[i] = "公休";
                        r.consecutive = 0;
                    }
                });

                // 再度候補リストを整理（新人で休み確定した人を除外）
                candidates = candidates.filter(s => s.assigns[i] === null || s.assigns[i] === "REQ_IN");

                // スコアリング & ソート
                candidates.sort((a, b) => {
                    // スコア計算: 高い方が優先的に出勤
                    let scoreA = 100;
                    let scoreB = 100;

                    // 連勤チェック: MAXに達していたら除外(別処理で弾くが念のためスコア下げ)
                    if (a.consecutive >= MAX_CONSECUTIVE_WORK) scoreA = -9999;
                    if (b.consecutive >= MAX_CONSECUTIVE_WORK) scoreB = -9999;

                    // 飛び石回避: 昨日休みなら、今日も休んで連休にしたい -> 出勤スコア下げる
                    const prevA = i > 0 ? a.assigns[i-1] : null;
                    const prevB = i > 0 ? b.assigns[i-1] : null;
                    const isOffA = prevA && ['公休','希望','有給','定休'].includes(prevA);
                    const isOffB = prevB && ['公休','希望','有給','定休'].includes(prevB);
                    
                    if (isOffA) scoreA -= 50;
                    if (isOffB) scoreB -= 50;

                    // 連休抑制: 連休重視でない人が既に2連休以上なら、今日は出勤させたい -> スコア上げ
                    if (!a.wantConsecutive && i > 1) {
                        const p2A = a.assigns[i-2];
                        if (isOffA && ['公休','希望','有給','定休'].includes(p2A)) scoreA += 80;
                    }
                    if (!b.wantConsecutive && i > 1) {
                        const p2B = b.assigns[i-2];
                        if (isOffB && ['公休','希望','有給','定休'].includes(p2B)) scoreB += 80;
                    }

                    // ランダム性
                    scoreA += Math.random() * 10;
                    scoreB += Math.random() * 10;

                    return scoreB - scoreA;
                });

                // 割り当て実行
                let currentAssignedCount = 0;
                // 既に決まっている人(行事、ヘルプ)をカウント
                staffSim.forEach(s => {
                    if (s.assigns[i] && !['公休','希望','有給','定休','-'].includes(s.assigns[i])) {
                        currentAssignedCount++;
                    }
                });

                let needed = Math.max(0, targetNum - currentAssignedCount);

                for (let s of candidates) {
                    if (s.assigns[i]) continue; // 決定済み

                    // 連勤ガード
                    if (s.consecutive >= MAX_CONSECUTIVE_WORK) {
                        s.assigns[i] = "公休";
                        s.consecutive = 0;
                        continue;
                    }

                    // 採用判定
                    let accepted = false;
                    
                    // スポット(REQ_IN)は無条件採用(連勤OKなら)
                    if (s.assigns[i] === "REQ_IN") {
                        accepted = true;
                    } else if (needed > 0) {
                        // 新人の場合、トレーナーもセットで空き枠が必要
                        if (s.role === 'rookie') {
                            const trainer = rookieTrainerMap.get(s.id);
                            // トレーナーがまだ未決定、かつ枠に余裕があるか？
                            // トレーナーが既に他の新人とセットで採用済みなら枠消費なし(共有)
                            const trainerAlreadyAssigned = assigned.includes(trainer);
                            const cost = trainerAlreadyAssigned ? 1 : 2; // 新人+トレーナー分

                            if (needed >= cost) {
                                accepted = true;
                                if (!trainerAlreadyAssigned) {
                                    // トレーナーも採用
                                    assigned.push(trainer);
                                    trainer.consecutive++;
                                    // 仮のシフトタイプ(後で上書き)
                                    trainer.assigns[i] = "TEMP"; 
                                    needed--;
                                }
                            }
                        } else if (s.isTrainer) {
                            // トレーナー単独採用 (新人とセットで採用されるケースは上記で処理)
                            // 自分の担当新人がまだ未処理なら待つ？ -> いや、スコア順なので自分が先なら採用
                            accepted = true;
                        } else {
                            // 通常スタッフ
                            accepted = true;
                        }
                    }

                    if (accepted) {
                        assigned.push(s);
                        s.consecutive++;
                        s.assigns[i] = "TEMP";
                        needed--;
                    } else {
                        s.assigns[i] = "公休";
                        s.consecutive = 0;
                    }
                }

                // -----------------------------------
                // シフトタイプ決定 (早/遅/フル) & 新人同期
                // -----------------------------------
                let earlyCount = 0;
                let lateCount = 0;
                
                // まずペアを処理 (新人とトレーナーを同じシフトに)
                const assignedRookies = assigned.filter(s => s.role === 'rookie');
                assignedRookies.forEach(r => {
                    const t = rookieTrainerMap.get(r.id);
                    // シフトタイプ決定
                    let type = 'フル';
                    if (shiftMode === 'complex') {
                        if (earlyCount <= lateCount) { type = '早'; } else { type = '遅'; }
                    }
                    
                    // 新人とトレーナーに適用
                    r.assigns[i] = type;
                    if (t.assigns[i] === "TEMP" || t.assigns[i] === type) {
                        t.assigns[i] = type;
                    } else {
                        // トレーナーが既に別のシフト(別の新人とのペアなど)になっている場合
                        // 多対1の場合、トレーナーのシフトに新人を合わせる
                        r.assigns[i] = t.assigns[i];
                    }

                    if(r.assigns[i] === '早') earlyCount++;
                    if(r.assigns[i] === '遅') lateCount++;
                });

                // 残りのメンバー処理
                assigned.forEach(s => {
                    if (s.assigns[i] === "TEMP" || s.assigns[i] === "REQ_IN") {
                        let type = 'フル';
                        if (shiftMode === 'complex') {
                            if (earlyCount <= lateCount) { type = '早'; earlyCount++; }
                            else { type = '遅'; lateCount++; }
                        }
                        s.assigns[i] = type;
                    }
                });
            }

            // 3. 休日数の強制調整 (トータル10日)
            // ここでの変更は「連勤制限」と「新人同期」を壊さないように慎重に行う
            staffSim.forEach(s => {
                if (!s.isFullTime) return;

                // 現在の休日数
                let holidays = s.assigns.filter(a => ['公休','希望','有給','定休'].includes(a)).length;
                let diff = FIXED_OFF_DAYS - holidays;

                if (diff > 0) {
                    // 休日が足りない -> 出勤日を公休に変える
                    // どこを変えるか？ -> 飛び石になっている出勤日などを優先
                    let workDays = s.assigns.map((v, idx) => ({v, idx})).filter(o => !['公休','希望','有給','定休','-'].includes(o.v));
                    
                    // シャッフルしてランダムに選ぶ（簡易）
                    workDays.sort(() => Math.random() - 0.5);

                    for (let wd of workDays) {
                        if (diff === 0) break;
                        
                        // 新人なら、トレーナーも休ませる必要があるか？ -> いや、新人が休む分にはトレーナーは単独出勤可なのでOK
                        // トレーナーの場合、担当新人がいるなら新人も休ませる必要がある
                        if (s.isTrainer) {
                            // この日、新人が自分とセットで出勤しているか確認
                            // 簡易的に全新人チェック
                            let linkedRookies = staffSim.filter(r => r.role === 'rookie' && !['公休','希望','有給','定休'].includes(r.assigns[wd.idx]));
                            // 本来はペア情報が必要だが、ここでは「トレーナーが休むなら、その日出勤の新人（自分とペアの可能性が高い）も道連れ」にするか、
                            // 安全のためトレーナーの休日化を避けるか。
                            // -> 安全のため、新人がいる日のトレーナーの休日化は避ける（スキップ）
                            if (linkedRookies.length > 0) continue; 
                        }

                        s.assigns[wd.idx] = '公休';
                        diff--;
                    }

                } else if (diff < 0) {
                    // 休日が多い -> 公休を出勤に変える
                    let offDays = s.assigns.map((v, idx) => ({v, idx})).filter(o => o.v === '公休');
                    offDays.sort(() => Math.random() - 0.5);

                    for (let od of offDays) {
                        if (diff === 0) break;
                        const idx = od.idx;

                        // 連勤チェック: ここを出勤にしてもMAXを超えないか？
                        // 前後の出勤状況を確認
                        let seq = 1;
                        // 前方
                        for (let k = idx - 1; k >= 0; k--) {
                            if (!['公休','希望','有給','定休'].includes(s.assigns[k])) seq++; else break;
                        }
                        // 後方
                        for (let k = idx + 1; k < daysInMonth; k++) {
                            if (!['公休','希望','有給','定休'].includes(s.assigns[k])) seq++; else break;
                        }

                        if (seq <= MAX_CONSECUTIVE_WORK) {
                            // 出勤可。新人の場合はトレーナーが必要なので、単独出勤できないならスキップ
                            if (s.role === 'rookie') {
                                // この日出勤のトレーナーがいるか？
                                const trainersOn = staffSim.some(t => t.isTrainer && !['公休','希望','有給','定休'].includes(t.assigns[idx]));
                                if (!trainersOn) continue; // トレーナーいないので出勤不可
                                // いるなら、そのトレーナーと同じシフトにする
                                const t = staffSim.find(t => t.isTrainer && !['公休','希望','有給','定休'].includes(t.assigns[idx]));
                                s.assigns[idx] = t.assigns[idx];
                            } else {
                                s.assigns[idx] = 'フル'; // 暫定
                            }
                            diff++;
                        }
                    }
                }
            });

            // 結果を整形してStateへ
            staffSim.forEach(s => {
                for (let i = 0; i < daysInMonth; i++) {
                    const k = `${s.id}_${getDateKey(i+1)}`;
                    if (s.assigns[i] && s.assigns[i] !== "REQ_IN") {
                        newSchedule[k] = s.assigns[i];
                    }
                }
            });

            setSchedule(newSchedule);
            setGenerationLog(logs);
            setActiveTab('result');
            
            const data = getExportData();
            data.schedule = newSchedule;
            data.generationLog = logs;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
          };

          // --- Excel Export ---
          const handleExcelExport = () => {
            if (!schedule) return;

            const getStyle = (val) => {
              if (val === '早') return 'background-color:#eff6ff; color:#1e40af; font-weight:bold;';
              if (val === '遅') return 'background-color:#fff7ed; color:#9a3412; font-weight:bold;';
              if (val === 'フル') return 'background-color:#faf5ff; color:#6b21a8; font-weight:bold;';
              if (val === '希望') return 'background-color:#d1d5db; color:#374151; font-weight:bold;';
              if (val === '有給') return 'background-color:#fbcfe8; color:#be185d; font-weight:bold;';
              if (val === '公休') return 'background-color:#e0f2fe; color:#0369a1;';
              if (val === '定休') return 'background-color:#fecaca; color:#991b1b;';
              if (val === '-') return 'color:#d1d5db;';
              
              const sEvt = staffEventTypes.find(e => e.name === val);
              if (sEvt) return `background-color:${sEvt.hexBg}; color:${sEvt.hexText}; font-weight:bold;`;
              if (val && val.length > 0) return 'background-color:#fef9c3; color:#854d0e; font-weight:bold;'; 
              return '';
            };

            let tableHTML = `
              <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
              <head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></head>
              <body><table border="1" style="border-collapse: collapse; font-family: sans-serif;">
                <thead><tr style="background-color: #1e293b; color: white;"><th style="padding: 5px;">スタッフ</th><th style="padding: 5px;">役職</th>
            `;
            dateList.forEach(d => {
              const isC = isClosed(d); const isEvt = isEventDay(d); const isH = isHoliday(d); const isW = isWeekend(d);
              const bg = isC ? '#fee2e2' : (isEvt ? '#fca5a5' : (isH ? '#fce7f3' : (isW ? '#fff7ed' : '#f8fafc')));
              const color = isC ? '#991b1b' : (isEvt ? '#7f1d1d' : (isH ? '#be185d' : '#000000'));
              tableHTML += `<th style="background-color:${bg}; color:${color}; padding:5px; width:30px;">${d}<br/><span style="font-size:10px;">${getWeekDay(d)}</span></th>`;
            });
            tableHTML += `<th style="padding:5px;">休日計</th></tr></thead><tbody>`;

            staffList.forEach(staff => {
              const r = Object.values(ROLES).find(role => role.id === staff.role) || ROLES.CREW;
              let offCount = 0;
              dateList.forEach(d => {
                  const v = schedule[`${staff.id}_${getDateKey(d)}`] || '';
                  if (['定休', '公休', '希望', '有給'].includes(v)) offCount++;
              });
              tableHTML += `<tr><td style="padding:5px; font-weight:bold;">${staff.name}</td><td style="padding:5px; font-size:12px; background-color:${r.hexBg}; color:${r.hexText};">${r.label}</td>`;
              dateList.forEach(d => {
                const val = schedule[`${staff.id}_${getDateKey(d)}`] || '';
                const style = getStyle(val);
                tableHTML += `<td style="text-align:center; padding:5px; ${style}">${val}</td>`;
              });
              tableHTML += `<td style="text-align:center; padding:5px; font-weight:bold;">${offCount}</td></tr>`;
            });

            tableHTML += `<tr><td colspan="2" style="padding:5px; font-weight:bold; text-align:right; background-color:#f1f5f9;">出勤計</td>`;
            dateList.forEach(d => {
                const key = getDateKey(d); let workers = 0;
                staffList.forEach(s => {
                    const v = schedule[`${s.id}_${key}`]; const isStaffEvt = staffEventTypes.some(ev => ev.name === v);
                    if (v && !['定休','公休','希望','有給','-'].includes(v) && !isStaffEvt) workers++;
                });
                tableHTML += `<td style="text-align:center; padding:5px; font-weight:bold; background-color:#f1f5f9;">${workers}</td>`;
            });
            tableHTML += `<td></td></tr></tbody></table></body></html>`;

            const blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a'); link.href = url;
            link.download = `${year}年${month}月${storeName || '店舗'}シフト.xls`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
          };

          const ModeToggle = () => (
            <div className="flex items-center gap-2 bg-white p-1 rounded border">
              <button onClick={() => setShiftMode('complex')} className={`px-3 py-1 text-xs rounded transition-colors ${shiftMode === 'complex' ? 'bg-blue-600 text-white' : 'text-gray-500'}`}>早/遅/フル</button>
              <button onClick={() => setShiftMode('simple')} className={`px-3 py-1 text-xs rounded transition-colors ${shiftMode === 'simple' ? 'bg-blue-600 text-white' : 'text-gray-500'}`}>フルのみ</button>
            </div>
          );

          return (
            <div className="min-h-screen bg-gray-50 p-2 md:p-6 font-sans text-gray-800">
              <div className="max-w-full mx-auto bg-white shadow-xl rounded-xl overflow-hidden min-h-[600px]">
                
                {/* Header */}
                <div className="bg-slate-800 p-4 text-white flex flex-col md:flex-row justify-between items-center gap-4">
                  <div>
                    <h1 className="text-xl md:text-2xl font-bold flex items-center gap-2">
                      <Icon name="RefreshCw" /> Shift Maker Pro <span className="text-xs bg-blue-600 px-2 py-1 rounded">Ver 26.7</span>
                    </h1>
                    <p className="opacity-80 text-sm mt-1">{storeName || '店舗名未設定'} | {year}年{month}月</p>
                  </div>
                  <div className="flex gap-2 items-center">
                    <button onClick={saveToLocal} className="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded text-sm flex items-center gap-2">
                      <Icon name="CheckCircle" size={16}/> 保存(ブラウザ)
                    </button>
                    <button onClick={resetLocal} className="bg-red-600 hover:bg-red-500 text-white px-3 py-2 rounded text-sm flex items-center gap-2">
                      <Icon name="Trash2" size={16}/> 初期化
                    </button>
                  </div>
                </div>

                {/* Tabs */}
                <div className="flex border-b overflow-x-auto bg-white">
                  <TabButton id="settings" label="基本設定" icon="Settings" isActive={activeTab === 'settings'} onClick={setActiveTab} />
                  <TabButton id="staff" label="スタッフ" icon="Users" isActive={activeTab === 'staff'} onClick={setActiveTab} />
                  <TabButton id="help" label="他店ヘルプ" icon="Truck" isActive={activeTab === 'help'} onClick={setActiveTab} />
                  <TabButton id="conditions" label="予定・希望休" icon="Calendar" isActive={activeTab === 'conditions'} onClick={setActiveTab} />
                  <TabButton id="result" label="シフト表" icon="CheckCircle" isActive={activeTab === 'result'} onClick={setActiveTab} />
                </div>

                <div className="p-4 md:p-6">
                  {activeTab === 'settings' && (
                    <div className="flex flex-col md:flex-row gap-6">
                      <div className="flex-1 space-y-6">
                        <h2 className="text-lg font-bold border-l-4 border-slate-500 pl-3 mb-4">基本設定</h2>
                        <div className="grid gap-4 bg-gray-50 p-4 rounded border">
                          <div><label className="block text-sm font-bold text-gray-700 mb-1">店舗名</label><input type="text" value={storeName} onChange={(e) => setStoreName(e.target.value)} className="w-full border rounded p-2" placeholder="例: 渋谷店"/></div>
                          <div className="flex gap-4">
                            <div className="w-1/2"><label className="block text-sm font-bold mb-1">年</label><input type="number" value={year} onChange={(e) => setYear(Number(e.target.value))} className="w-full border rounded p-2"/></div>
                            <div className="w-1/2"><label className="block text-sm font-bold mb-1">月</label><select value={month} onChange={(e) => setMonth(Number(e.target.value))} className="w-full border rounded p-2">{[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}月</option>)}</select></div>
                          </div>
                          <div><label className="block text-sm font-bold text-gray-700 mb-1">シフト種別</label><ModeToggle /></div>
                        </div>
                        <div className="bg-blue-50 p-4 rounded border border-blue-200">
                          <h3 className="font-bold text-blue-800 text-sm mb-3 flex items-center gap-2"><Icon name="Users" size={16}/> 必要人数設定</h3>
                          <div className="grid grid-cols-3 gap-4 text-center">
                            <div><label className="block text-xs font-bold text-gray-600 mb-1">平日</label><input type="number" min="1" value={reqWeekday} onChange={(e) => setReqWeekday(Number(e.target.value))} className="w-full border rounded p-2 text-center"/></div>
                            <div><label className="block text-xs font-bold text-orange-600 mb-1">週末・祝日</label><input type="number" min="1" value={reqWeekend} onChange={(e) => setReqWeekend(Number(e.target.value))} className="w-full border rounded p-2 text-center font-bold text-orange-600 bg-orange-50"/></div>
                            <div><label className="block text-xs font-bold text-red-600 mb-1">イベント日</label><input type="number" min="1" value={reqEvent} onChange={(e) => setReqEvent(Number(e.target.value))} className="w-full border rounded p-2 text-center font-bold text-red-600 bg-red-50"/></div>
                          </div>
                        </div>
                        <div className="bg-red-50 p-4 rounded border border-red-100">
                          <h3 className="font-bold text-red-800 text-sm mb-2">曜日定休設定</h3>
                          <div className="flex gap-2 flex-wrap">{WEEKDAYS.map((day, i) => (<button key={i} onClick={() => toggleClosedWeekDay(i)} className={`w-10 h-10 rounded-full font-bold transition-colors ${closedWeekDays.includes(i) ? 'bg-red-500 text-white shadow-inner' : 'bg-white border text-gray-500 hover:bg-gray-100'}`}>{day}</button>))}</div>
                        </div>
                      </div>
                      <div className="flex-1">
                         <h2 className="text-lg font-bold border-l-4 border-red-400 pl-3 mb-4">特定日の定休設定</h2>
                         <div className="bg-white p-4 border rounded shadow-sm"><div className="grid grid-cols-7 gap-1">{WEEKDAYS.map(d => <div key={d} className="text-center text-xs font-bold py-1 bg-gray-100">{d}</div>)}{dateList.map(d => { const isC = isClosed(d); return (<button key={d} onClick={() => toggleSpecificClosedDay(d)} className={`h-10 text-sm border rounded hover:bg-red-100 ${isC ? 'bg-red-500 text-white font-bold' : 'bg-white'}`}>{d}</button>); })}</div></div>
                      </div>
                    </div>
                  )}

                  {activeTab === 'staff' && (
                    <div className="space-y-4">
                      <h2 className="text-lg font-bold border-l-4 border-slate-500 pl-3">スタッフ管理</h2>
                      <div className="bg-blue-50 p-4 rounded border flex flex-wrap gap-2 items-end">
                        <div className="flex-1 min-w-[150px]"><label className="text-xs font-bold text-gray-500">氏名</label><input type="text" value={newStaffName} onChange={(e) => setNewStaffName(e.target.value)} className="w-full border rounded p-2" placeholder="名前"/></div>
                        <div className="w-40"><label className="text-xs font-bold text-gray-500">属性</label><select value={newStaffRole} onChange={(e) => setNewStaffRole(e.target.value)} className="w-full border rounded p-2">{Object.values(ROLES).map(r => <option key={r.id} value={r.id}>{r.label}</option>)}</select></div>
                        <button onClick={addStaff} disabled={!newStaffName} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">追加</button>
                      </div>
                      <div className="grid grid-cols-1 gap-3">
                        {staffList.map((s, index) => {
                          const r = Object.values(ROLES).find(role => role.id === s.role) || ROLES.CREW;
                          return (
                            <div key={s.id} className="flex justify-between items-center p-3 border rounded bg-white shadow-sm">
                              <div className="flex items-center gap-3">
                                <div className="flex flex-col gap-1">
                                    <button onClick={() => moveStaff(index, -1)} className="text-gray-400 hover:text-blue-500 disabled:opacity-30" disabled={index===0}><Icon name="ChevronUp" size={16}/></button>
                                    <button onClick={() => moveStaff(index, 1)} className="text-gray-400 hover:text-blue-500 disabled:opacity-30" disabled={index===staffList.length-1}><Icon name="ChevronDown" size={16}/></button>
                                </div>
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center ${r.color}`}>{r.icon}</div>
                                <div>
                                    <p className="font-bold text-sm">{s.name}</p>
                                    <p className="text-xs text-gray-500">{r.label}</p>
                                </div>
                              </div>
                              <div className="flex items-center gap-4">
                                <label className={`flex items-center gap-1 text-xs cursor-pointer px-2 py-1 rounded border ${s.isTrainer ? 'bg-indigo-100 text-indigo-700 border-indigo-200 font-bold' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                    <input type="checkbox" checked={s.isTrainer} onChange={() => toggleStaffAttribute(s.id, 'isTrainer')} className="hidden"/>
                                    <Icon name="Shield" size={14} /> 教育担当
                                </label>
                                <label className={`flex items-center gap-1 text-xs cursor-pointer px-2 py-1 rounded border ${s.wantConsecutive ? 'bg-emerald-100 text-emerald-700 border-emerald-200 font-bold' : 'bg-gray-50 text-gray-400 border-gray-200'}`}>
                                    <input type="checkbox" checked={s.wantConsecutive} onChange={() => toggleStaffAttribute(s.id, 'wantConsecutive')} className="hidden"/>
                                    <Icon name="Calendar" size={14} /> 連休重視
                                </label>
                                <button onClick={() => removeStaff(s.id)} className="text-gray-300 hover:text-red-500 ml-2"><Icon name="Trash2" size={18}/></button>
                              </div>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}

                  {activeTab === 'help' && (
                    <div className="space-y-6">
                      <h2 className="text-lg font-bold border-l-4 border-slate-500 pl-3">他店ヘルプ派遣</h2>
                      <div className="bg-yellow-50 p-4 rounded border border-yellow-200"><h3 className="text-sm font-bold text-yellow-800 mb-2">派遣先店舗登録</h3><div className="flex gap-2"><input type="text" value={newHelpStore} onChange={(e) => setNewHelpStore(e.target.value)} maxLength={4} className="border p-2 rounded" placeholder="店舗名"/><button onClick={addHelpStore} className="bg-yellow-600 text-white px-4 rounded">登録</button></div><div className="flex gap-2 mt-2 flex-wrap">{helpStores.map(s => (<span key={s} className="bg-white px-2 py-1 rounded text-xs border flex gap-1 items-center">{s} <button onClick={() => removeHelpStore(s)} className="text-red-400">×</button></span>))}</div></div>
                      <div className="overflow-x-auto border rounded">
                        <table className="w-full text-xs"><thead><tr><th className="sticky-name-col p-2 border-b bg-gray-100">スタッフ(派遣元)</th>{dateList.map(d => <th key={d} className={`min-w-[30px] border-r p-1 text-center ${isWeekend(d)?'bg-orange-50':''}`}>{d}</th>)}</tr></thead>
                          <tbody>{staffList.filter(s => s.role !== 'help_guest').map(s => (<tr key={s.id}><td className="sticky-name-col p-2 border-b font-medium">{s.name}</td>{dateList.map(d => { const key = `${s.id}_${getDateKey(d)}`; return (<td key={d} className="border-r border-b p-0 h-8"><select value={helpAssignments[key]||''} onChange={(e)=>handleHelpAssignment(s.id, d, e.target.value)} className={`w-full h-full text-center border-none focus:ring-0 text-[10px] ${helpAssignments[key]?'bg-yellow-100 font-bold':''}`}><option value="">-</option>{helpStores.map(hs => <option key={hs} value={hs}>{hs}</option>)}</select></td>);})}</tr>))}</tbody>
                        </table>
                      </div>
                    </div>
                  )}

                  {activeTab === 'conditions' && (
                    <div className="space-y-6">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="bg-gray-50 p-4 rounded border border-gray-200"><h3 className="text-sm font-bold text-gray-800 mb-2 flex gap-2 items-center"><Icon name="Flag" size={16}/> 店舗イベント</h3><div className="flex gap-2 mb-3"><input type="text" value={newStoreEventName} onChange={(e)=>setNewStoreEventName(e.target.value)} className="border p-2 rounded w-full" placeholder="例: お客様感謝デー"/><button onClick={addStoreEventType} className="bg-gray-700 text-white px-4 rounded whitespace-nowrap">追加</button></div><div className="flex gap-2 flex-wrap">{storeEventTypes.map(ev => (<div key={ev.id} className={`${ev.color} px-3 py-1 rounded-full text-xs flex items-center gap-2 shadow-sm`}>{ev.name}<button onClick={()=>removeStoreEventType(ev.id)} className="hover:text-red-300">×</button></div>))}</div></div>
                        <div className="bg-indigo-50 p-4 rounded border border-indigo-200"><h3 className="text-sm font-bold text-indigo-800 mb-2 flex gap-2 items-center"><Icon name="User" size={16}/> スタッフ行事</h3><div className="flex gap-2 mb-3"><input type="text" value={newStaffEventName} onChange={(e)=>setNewStaffEventName(e.target.value)} className="border p-2 rounded w-full" placeholder="例: 研修"/><button onClick={addStaffEventType} className="bg-indigo-600 text-white px-4 rounded whitespace-nowrap">追加</button></div><div className="flex gap-2 flex-wrap">{staffEventTypes.map(ev => (<div key={ev.id} className={`${ev.color} px-3 py-1 rounded-full text-xs flex items-center gap-2 shadow-sm`}>{ev.name}<button onClick={()=>removeStaffEventType(ev.id)} className="hover:text-red-500">×</button></div>))}</div></div>
                      </div>
                      <div className="overflow-x-auto border rounded shadow-inner max-h-[500px]">
                        <table className="min-w-max border-collapse text-xs">
                          <thead className="sticky top-0 z-20 shadow-sm">
                            <tr><th className="sticky-name-col bg-gray-100 p-2 border-b">日付 / 店舗設定</th>{dateList.map(d => { const isH = isHoliday(d); const isC = isClosed(d); const isW = isWeekend(d); const headerClass = isC ? 'bg-red-100 text-red-800' : (isH ? 'bg-pink-100 text-pink-800' : (isW ? 'bg-orange-50' : 'bg-white')); return (<th key={d} className={`p-1 border min-w-[40px] text-center ${headerClass}`}><div>{d}</div><div className="text-[9px]">{getWeekDay(d)}</div></th>);})}</tr>
                            <tr><th className="sticky-name-col bg-gray-200 p-2 border-b text-left"><div className="font-bold text-xs">店舗イベント</div></th>{dateList.map(d => { const key = getDateKey(d); const evId = dailyStoreEvents[key]; const evDef = storeEventTypes.find(e => e.id === evId); return (<td key={d} onClick={() => toggleDailyStoreEvent(d)} className={`border text-center cursor-pointer hover:opacity-80 transition-colors h-8 ${evDef ? evDef.color : 'bg-white'}`}>{evDef && <span className="text-[9px] leading-tight block">{evDef.name.substring(0,3)}</span>}</td>);})}</tr>
                          </thead>
                          <tbody>
                            {staffList.map(staff => (
                              <tr key={staff.id}>
                                <td className="sticky-name-col bg-white p-2 border-b">
                                  <div className="flex justify-between items-center mb-1"><span className="font-bold text-sm">{staff.name}</span>{(staff.role === 'help_guest' || staff.role === 'event') && (<button onClick={() => toggleAllHelpDates(staff.id, staff.role)} className="text-xs bg-teal-100 text-teal-800 px-1 rounded hover:bg-teal-200 border border-teal-300" title="日付全選択/全解除">全</button>)}</div>
                                  <div className="flex gap-1">
                                    <span className={`text-[10px] px-1 rounded w-max ${ROLES[staff.role.toUpperCase()]?.color}`}>{ROLES[staff.role.toUpperCase()]?.label}</span>
                                    {staff.isTrainer && <Icon name="Shield" size={12} className="text-indigo-600"/>}
                                    {staff.wantConsecutive && <Icon name="Calendar" size={12} className="text-emerald-600"/>}
                                  </div>
                                </td>
                                {dateList.map(d => {
                                  const key = `${staff.id}_${getDateKey(d)}`;
                                  const req = requests[key];
                                  const isGuestLike = (staff.role === 'help_guest' || staff.role === 'event');
                                  let cellClass = "cursor-pointer hover:bg-gray-100";
                                  let content = "-";
                                  if (isClosed(d)) return <td key={d} className="border border-b bg-red-50 text-red-300 text-center text-[10px]">休</td>;
                                  if (isGuestLike) { const mark = staff.role === 'event' ? 'event_in' : 'guest_in'; const label = staff.role === 'event' ? '出勤' : '受入'; if (req === mark) { cellClass = "bg-teal-100 text-teal-800 font-bold border-teal-200"; content = label; } } else { if (req === 'off') { cellClass = "bg-gray-300 text-gray-700 font-bold"; content = "希"; } else if (req === 'paid') { cellClass = "bg-pink-300 text-pink-700 font-bold"; content = "有"; } else { const sEvent = staffEventTypes.find(e => e.id === req); if (sEvent) { cellClass = `${sEvent.color} font-bold`; content = sEvent.name.substring(0,2); } } }
                                  return (<td key={d} className={`border border-b text-center p-1 transition-colors ${cellClass}`} onClick={() => handleRequestChange(staff.id, d, staff.role)}>{content}</td>);
                                })}
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}

                  {activeTab === 'result' && (
                    <div className="space-y-4">
                      <div className="flex flex-wrap justify-between items-center bg-gray-100 p-3 rounded-lg gap-3">
                        <h2 className="text-lg font-bold text-gray-700 flex gap-2 items-center"><Icon name="CheckCircle" className="text-blue-600"/> シフト表</h2>
                        <div className="flex gap-2">
                          <button onClick={generateShift} className="bg-blue-600 text-white px-4 py-2 rounded font-bold shadow hover:bg-blue-700 flex gap-2"><Icon name="RefreshCw" size={18}/> 作成実行</button>
                          {schedule && (<button onClick={handleExcelExport} className="bg-green-700 text-white px-4 py-2 rounded font-bold shadow hover:bg-green-800 flex gap-2"><Icon name="FileSpreadsheet" size={18}/> エクセル出力</button>)}
                        </div>
                      </div>
                      {generationLog.length > 0 && (<div className="bg-amber-50 p-3 rounded text-xs text-amber-800 border border-amber-200 max-h-32 overflow-y-auto"><div className="font-bold mb-1">生成ログ:</div>{generationLog.map((l, i) => <div key={i}>・{l}</div>)}</div>)}
                      {schedule && (
                        <div className="overflow-x-auto shadow-lg rounded border">
                          <table className="min-w-max border-collapse text-xs bg-white">
                            <thead><tr><th className="sticky-name-col bg-gray-100 p-2 border-b min-w-[120px]">スタッフ</th>{dateList.map(d => { const key = getDateKey(d); const isEvt = isEventDay(d); const isC = isClosed(d); const isH = isHoliday(d); const isW = isWeekend(d); const headerColor = isC ? 'bg-red-100 text-red-800' : (isEvt ? 'bg-red-200 text-red-900' : (isH ? 'bg-pink-100 text-pink-800' : (isW ? 'bg-orange-50' : 'bg-gray-50'))); return (<th key={d} className={`p-1 border min-w-[35px] text-center ${headerColor}`}><div>{d}</div><div className="text-[8px] font-normal">{getWeekDay(d)}</div>{isEvt && <div className="text-[8px] font-bold">EVT</div>}</th>); })}<th className="bg-gray-800 text-white border px-1">休日計</th></tr></thead>
                            <tbody>
                              {staffList.map(staff => {
                                let counts = { 休日計:0 };
                                dateList.forEach(d => { const v = schedule[`${staff.id}_${getDateKey(d)}`]; if (['定休', '公休', '希望', '有給'].includes(v)) counts.休日計++; });
                                return (<tr key={staff.id} className="hover:bg-blue-50">
                                  <td className="sticky-name-col bg-white p-2 border-b">
                                    <div className="font-medium text-gray-700 text-sm mb-1">{staff.name}</div>
                                    <div className="flex gap-1 items-center">
                                      <span className={`text-[10px] px-1 rounded w-max ${ROLES[staff.role.toUpperCase()]?.color}`}>
                                        {ROLES[staff.role.toUpperCase()]?.label}
                                      </span>
                                      {staff.isTrainer && <Icon name="Shield" size={12} className="text-indigo-600"/>}
                                      {staff.wantConsecutive && <Icon name="Calendar" size={12} className="text-emerald-600"/>}
                                    </div>
                                  </td>
                                  {dateList.map(d => { const key = `${staff.id}_${getDateKey(d)}`; const val = schedule[key] || '-'; let style = "text-gray-400"; if (val === '早') { style = "text-blue-600 font-bold bg-blue-50"; } else if (val === '遅') { style = "text-orange-600 font-bold bg-orange-50"; } else if (val === 'フル') { style = "text-purple-600 font-bold bg-purple-50"; } else if (val === '希望') { style = "bg-gray-300 text-gray-700"; } else if (val === '有給') { style = "bg-pink-200 text-pink-700"; } else if (val === '公休') { style = "bg-sky-100 text-sky-600"; } else if (val === '定休') { style = "bg-red-100 text-red-600"; } else if (val === '-') { style = "text-gray-300"; } else { const sEvt = staffEventTypes.find(e => e.name === val); if (sEvt) style = `${sEvt.color} font-bold`; else if (val.length > 0) style = "bg-yellow-100 text-yellow-800 font-bold text-[9px]"; } return <td key={d} className={`border border-b text-center p-1 ${style}`}>{val.length > 3 ? val.substring(0,2) : val}</td>; })}<td className={`border border-b text-center font-bold ${counts.休日計 !== FIXED_OFF_DAYS && !(staff.role === 'help_guest' || staff.role === 'event') ? 'text-red-600 bg-red-100' : 'bg-green-100 text-green-700'}`}>{counts.休日計}</td></tr>);
                              })}
                              <tr className="bg-slate-700 text-white font-bold text-[10px]">
                                <td className="sticky-name-col bg-slate-700 p-2 text-right">出勤計</td>
                                {dateList.map(d => {
                                  if (isClosed(d)) return <td key={d} className="border border-b bg-red-900 text-center">-</td>;
                                  const key = getDateKey(d); const targetNum = getRequiredNum(d); let workers = 0;
                                  staffList.forEach(s => { const v = schedule[`${s.id}_${key}`]; const isStaffEvt = staffEventTypes.some(ev => ev.name === v); if (v && !['定休','公休','希望','有給','-'].includes(v) && !isStaffEvt) workers++; });
                                  const colorClass = workers < targetNum ? 'bg-red-600' : 'bg-slate-700';
                                  return (<td key={d} className={`border border-b text-center ${colorClass}`}>{workers}<span className="opacity-50">/{targetNum}</span></td>);
                                })}
                                <td></td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                      )}
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
